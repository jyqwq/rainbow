import{_ as i,c as a,f as n,o as l}from"./app-t7sSfxVc.js";const e={};function h(t,s){return l(),a("div",null,s[0]||(s[0]=[n(`<h2 id="docker-compose" tabindex="-1"><a class="header-anchor" href="#docker-compose"><span>Docker Compose</span></a></h2><h3 id="简介" tabindex="-1"><a class="header-anchor" href="#简介"><span>简介</span></a></h3><p>Docker Compose 是 Docker 官方编排(Orchestration)项目之一，负责快速在集群中部署分布式应用。该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。</p><p>Dockerfile 可以让用户管理一个单独的应用容器;而 Compose 则允许用户在一个模板(YAML 格式)中定 义一组相关联的应用容器(被称为一个 project ，即项目)，例如一个 Web 服务容器再加上后端的数据 库服务容器等。</p><p>定义运行多个容器来轻松高效的管理容器。</p><ul><li>定义、运行多个容器</li><li>YAML file配置文件</li><li>单一指令</li><li>所有环境都可以使用Compose</li><li>三个步骤 <ol><li>Dockerfile</li><li>docker-compose.yml</li><li>启动项目 docker-compose up</li></ol></li></ul><blockquote><p>官方说明</p><p>Compose是一个用于定义和运行多容器Docker应用程序的工具。使用Compose，可以使用YAML文件来配置应用程序的服务。然后，使用一个命令，从配置中创建并启动所有服务。</p><p>Compose适用于所有环境：生产、暂存、开发、测试以及CI工作流。</p><p>使用Compose基本上分为三个步骤：</p><ol><li>使用“Dockerfile”定义应用程序的环境，以便可以在任何地方复制。</li><li>在“docker compose.yml”中定义组成应用程序的服务，以便它们可以在隔离的环境中一起运行。</li><li>运行“docker compose up”和启动并运行整个应用程序。</li></ol></blockquote><p><strong>为什么不在一个单一的容器里运行多个程序?</strong></p><ol><li>透明化。为了使容器组中的容器保持一致的基础设施和服务，比如进程管理和资源监控。这样设计是 为了用户的便利性。</li><li>解耦软件之间的依赖。每个容器都可能重新构建和发布。</li><li>方便使用。用户不必运行独立的程序管理，也不用担心每个运用程序的退出状态。</li><li>高效。考虑到基础设施有更多的职责，容器必须要轻量化。</li></ol><p>作用：<strong>批量容器编排</strong></p><p>Compose是Docker官方的开源项目，需要安装。</p><p>Docker desktop自带compose。</p><blockquote><p>docker-compose.yml文件如下结构</p></blockquote><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3.9</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">  # optional since v1.27.0</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  web</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    build</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> .</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">5000:5000</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> .:/code</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> logvolume01:/var/log</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    links</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  logvolume01</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>假如有100个服务，利用docker-compose up可以一键启动</p><p><strong>Compose重要的概念：</strong></p><ul><li><strong>服务services。一个应用容器，实际上可以运行多个相同镜像的实例。容器。应用（web、redis、mysql……）</strong></li><li><strong>项目project。由一组关联的应用容器组成的一个完整业务单元。例如：博客（web、mysql、wp……）</strong></li></ul><h3 id="安装" tabindex="-1"><a class="header-anchor" href="#安装"><span>安装</span></a></h3><p>https://docs.docker.com/compose/install/</p><h3 id="体验" tabindex="-1"><a class="header-anchor" href="#体验"><span>体验</span></a></h3><p>https://docs.docker.com/compose/gettingstarted/</p><ol><li><p>第一步，创建应用app.py</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mkdir</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> composetest</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">cd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> composetest</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> app.py</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>app.py</p><div class="language-python line-numbers-mode" data-ext="python" data-title="python"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> time</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> redis</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">from</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> flask </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">import</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Flask</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">app </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> Flask</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">__name__</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">cache </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">host</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">redis</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">,</span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;"> port</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">6379</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">def</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> get_hit_count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">():</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    retries </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 5</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    while</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> True</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        try</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            return</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> cache</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">incr</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hits</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">        except</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">exceptions</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ConnectionError </span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">as</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> exc</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">            if</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> retries </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">==</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">                raise</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> exc</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            retries </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">-=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            time</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">sleep</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0.5</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">@</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">route</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">def</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> hello</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">():</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    count </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> get_hit_count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">()</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">    return</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Hello World! I have been seen </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">{}</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> times.</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">\\n</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">.</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">format</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">(</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">count</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> requirements.txt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>requirements.txt</p><div class="language- line-numbers-mode" data-ext="" data-title=""><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span>flask</span></span>
<span class="line"><span>redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>创建一个Dockerfile，应用打包为镜像</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Dockerfile</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>Dockerfile</p><div class="language-dockerfile line-numbers-mode" data-ext="dockerfile" data-title="dockerfile"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">FROM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> python:3.7-alpine</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">WORKDIR</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> /code</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">ENV</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> FLASK_APP=app.py</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">ENV</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> FLASK_RUN_HOST=0.0.0.0</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">RUN</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> sed -i </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&#39;s/dl-cdn.alpinelinux.org/mirrors.aliyun.com/g&#39;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> /etc/apk/repositories</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">RUN</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> apk add --no-cache gcc musl-dev linux-headers</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">COPY</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> requirements.txt requirements.txt</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">RUN</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> pip install -r requirements.txt</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">EXPOSE</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> 5000</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">COPY</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> . .</span></span>
<span class="line"><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;">CMD</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&quot;flask&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">, </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">&quot;run&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>官方解释</p><p>This tells Docker to:</p><ul><li>Build an image starting with the Python 3.7 image.</li><li>Set the working directory to <code>/code</code>.</li><li>Set environment variables used by the <code>flask</code> command.</li><li>Install gcc and other dependencies</li><li>Copy <code>requirements.txt</code> and install the Python dependencies.</li><li>Add metadata to the image to describe that the container is listening on port 5000</li><li>Copy the current directory <code>.</code> in the project to the workdir <code>.</code> in the image.</li><li>Set the default command for the container to <code>flask run</code>.</li></ul></blockquote></li><li><p>第三步，创建docker-compose.yml文件（定义整个服务，需要的环境。web、redis）</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">vim</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker-compose.yml</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>docker-compose.yml</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3.9</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  web</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    build</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> .</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">5000:5000</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  redis</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">redis:alpine</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>第四步，启动compose项目（docker-compose up）</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker-compose</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> up</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li></ol><p><strong>流程</strong></p><ol><li><p>创建网络（项目中的内容都在同个网络下。域名访问）</p></li><li><p>执行docker-compose.yml</p></li><li><p>启动服务</p><p>docker-compose.yml</p><p>Creating composetest_web_1 ...done</p><p>Creating composetest_redis_1 ...done</p><ol><li>文件名 conposetest</li><li>服务 web</li><li>副本数量 1</li></ol></li></ol><p><strong>停止</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker-compose</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> down</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker-compose</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stop</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="yaml规则" tabindex="-1"><a class="header-anchor" href="#yaml规则"><span>yaml规则</span></a></h3><p>https://docs.docker.com/compose/compose-file/compose-file-v3/</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 3层</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">version:&#39;&#39;</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #版本</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">service</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #服务</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	服务1:web</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">		#服务配置</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		images</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		build</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		network</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		depends_on</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #依赖 先启动依赖</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">			-redis</span></span>
<span class="line"><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">		...</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	服务2:redis</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	服务3...</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;">#其他配置 网络/卷、全局规则</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">configs</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h3 id="开源项目" tabindex="-1"><a class="header-anchor" href="#开源项目"><span>开源项目</span></a></h3><p><strong>wordpress博客</strong></p><p>https://docs.docker.com/samples/wordpress/</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3.9</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  db</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  	platform</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> linux/x86_64</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql:5.7</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> db_data:/var/lib/mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    restart</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> always</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> somewordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_DATABASE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_USER</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_PASSWORD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    </span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  wordpress</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    depends_on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> db</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress:latest</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">8000:80</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    restart</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> always</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_HOST</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> db:3306</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_USER</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_PASSWORD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_NAME</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  db_data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> {}</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在此yaml文件下运行<code>docker-compose up/docker-compose up -d</code>，然后访问<code>localhost:8000</code>就可以看到wordpress操作页面。</p><h3 id="实战" tabindex="-1"><a class="header-anchor" href="#实战"><span>实战</span></a></h3><ol><li>编写项目微服务，打包jar</li><li>dockerfile构建镜像</li><li>docker-compose.yml编排项目</li><li>三个文件放到服务器同一目录下执行<code>docker-compose up</code></li></ol><h2 id="docker-swarm" tabindex="-1"><a class="header-anchor" href="#docker-swarm"><span>Docker Swarm</span></a></h2><ol><li>准备4台1核2G的服务器用于构建集群，1主3从！</li><li>服务器镜像使用centOS7及以上版本</li></ol><h3 id="_4台服务器安装docker" tabindex="-1"><a class="header-anchor" href="#_4台服务器安装docker"><span>4台服务器安装docker</span></a></h3><ol><li><p>yum安装gcc相关环境</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gcc</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> gcc-c++</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>卸载旧版本</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> remove</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">									docker-client</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">									docker-client-latest</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">									docker-common</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">									docker-latest</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">									docker-latest-logrotate</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">									docker-logrotate</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">									docker-engine</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>安装需要的软件包</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> yum-utils</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>设置镜像仓库</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum-config-manager</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --add-repo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http://mirrors.aliyun.com/docker-ce/linux/centos/docker-ce.repo</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>更新yum软件包索引</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> makecache</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> fast</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>安装Docker CE</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yum</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> install</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -y</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker-ce</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker-ce-cli</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> containerd.io</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>启动Docker</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> start</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>测试命令</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> version</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>配置镜像加速</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mkdir</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/docker</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tee</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /etc/docker/daemon.json</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;&lt;-</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;EOF&#39;</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	&quot;registry-mirrors&quot;:[&quot;https://qiyb9988.mirror.aliyuncs.com&quot;]</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">}</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">EOF</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> daemon-reload</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">sudo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> systemctl</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> restart</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h3 id="官方文档" tabindex="-1"><a class="header-anchor" href="#官方文档"><span>官方文档</span></a></h3><p>https://docs.docker.com/engine/swarm/</p><h3 id="raft协议-一致性协议" tabindex="-1"><a class="header-anchor" href="#raft协议-一致性协议"><span>Raft协议（一致性协议）</span></a></h3><p><img src="https://file.40017.cn/baoxian/health/health_public/images/blog/blog-6.png" alt="swarm-diagram.png"></p><p>双主双从：如果一个manager节点挂了，另外一个就不能用了。</p><p>Raft协议：保证大多数节点存活才可用，高可用。普通的需要大于一个节点，集群需要大于3个节点。</p><h3 id="搭建集群" tabindex="-1"><a class="header-anchor" href="#搭建集群"><span>搭建集群</span></a></h3><ol><li><p><strong>在第一台服务器初始化一个Swarm</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> init</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --advertise-addr</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 当前内网ip</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>如果使用Docker Desktop for Mac或Docker Desktop for Windows来测试单节点swarm，只需运行<code>docker swarm init</code>而不带任何参数</p></li></ol><p><img src="https://file.40017.cn/baoxian/health/health_public/images/blog/blog-7.png" alt="image-20210518223315143.png"></p><p>运行<code>docker info</code>查看群集的当前状态:</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> info</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Containers:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Running:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Paused:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Stopped:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  ..</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.snip.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Swarm:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> active</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  NodeID:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dxn1zf6l61qsb1josjja83ngz</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  Is</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Manager:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  Managers:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">  Nodes:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  ..</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.snip.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行<code>docker node ls</code>命令以查看有关节点的信息：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ls</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           HOSTNAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  AVAILABILITY</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  MANAGER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATUS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">dxn1zf6l61qsb1josjja83ngz</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  manager1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Active</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Leader</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>节点ID旁边的*表示您当前已连接到此节点。</p><p>Docker Engine swarm模式自动为机器主机名命名节点。</p><ol start="2"><li><p><strong>加入节点</strong></p><p>一旦创建了一个带有管理器节点的swarm，就可以添加worker节点了。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 加入一个节点</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> join</span></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># 获取令牌</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> join-token</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> manager</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> join-token</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> join</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --token</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  192.168.99.100:2377</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">This</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> joined</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> as</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker.</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> join-token</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">To</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> add</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> this</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm,</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> the</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> following</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> command:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> swarm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> join</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">    --token</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> SWMTKN-1-49nj1cmql0jkz5s954yi3oex3nedyz0fb0xx14ie39trti4wxv-8vxv8rssmk743ojnwacrr2e7c</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    192.168.99.100:2377</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>打开一个终端，ssh到manager节点运行的机器中，运行<code>docker node ls</code>命令查看工作节点：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           HOSTNAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  AVAILABILITY</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  MANAGER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATUS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">03g1y59jwfg7cf99w4lt0f662</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Active</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">9j68exjopxe7wfl6yuxml7a7j</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Active</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">dxn1zf6l61qsb1josjja83ngz</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  manager1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Active</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Leader</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>MANAGER列标识群中的管理器节点。worker1和worker2的此列中的空状态将它们标识为工作节点。</p><p>docker node ls等群管理命令只在管理器节点上工作。</p></li></ol><h3 id="部署服务" tabindex="-1"><a class="header-anchor" href="#部署服务"><span>部署服务</span></a></h3><h4 id="向swarm部署服务" tabindex="-1"><a class="header-anchor" href="#向swarm部署服务"><span><strong>向swarm部署服务</strong></span></a></h4><p>创建集群之后，可以将服务部署到集群。运行以下命令：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --replicas</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ping</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker.com</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">9uk4639qpg7npwf3fn2aasksr</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>docker service create</code>命令创建服务。</li><li><code>--name</code> 将服务命名为helloworld。</li><li><code>--replicas</code> 指定1个运行实例的所需状态。</li><li>参数<code>alpine ping docker.com</code>将服务定义为执行命令ping docker.com的alpine Linux容器。</li></ul><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> run</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 容器启动！不具有扩缩容器</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 服务！具有扩缩容器，滚动更新</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>运行 <code>docker service ls</code> 查看正在运行的服务列表：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ls</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        SCALE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   COMMAND</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">9uk4639qpg7n</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  helloworld</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  ping</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker.com</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="在swarm上检查服务" tabindex="-1"><a class="header-anchor" href="#在swarm上检查服务"><span><strong>在swarm上检查服务</strong></span></a></h4><p>运行<code>docker service inspect --pretty &lt;service-ID&gt;</code>以易于阅读的格式显示有关服务的详细信息。查看helloworld服务的详细信息：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">manager1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">$ docker service inspect --pretty helloworld</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		9uk4639qpg7npwf3fn2aasksr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		helloworld</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Mode:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	REPLICATED</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Replicas:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">		1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Placement:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">UpdateConfig:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Parallelism:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">	1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ContainerSpec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		alpine</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Args:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	ping</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker.com</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Resources:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Endpoint</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Mode:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  vip</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>要以json格式返回服务详细信息，运行不带--pretty标志的相同命令。</p></blockquote><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">manager1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">$ docker service inspect helloworld</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">{</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ID</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">9uk4639qpg7npwf3fn2aasksr</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Index</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">418</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CreatedAt</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2016-06-16T21:57:11.622222327Z</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">UpdatedAt</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2016-06-16T21:57:11.622222327Z</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Spec</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Name</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">helloworld</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">TaskTemplate</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ContainerSpec</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Image</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">alpine</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Args</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">                ]</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Resources</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Limits</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {},</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Reservations</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {}</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">RestartPolicy</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Condition</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">any</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">MaxAttempts</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">0</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Placement</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {}</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Mode</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Replicated</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Replicas</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">            }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">UpdateConfig</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Parallelism</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">1</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">EndpointSpec</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Mode</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">vip</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">    &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Endpoint</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Spec</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {}</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">}</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>运行<code>docker service ps &lt;service-ID&gt;</code>查看哪些节点正在运行服务：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">manager1</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">$ docker service ps helloworld</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     DESIRED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  CURRENT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     ERROR</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> PORTS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">helloworld.1...</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在本例中，helloworld服务的一个实例正在worker2节点上运行。也可能会看到服务正在manager节点上运行。默认情况下，群中的管理节点可以像工作节点一样执行任务。</p><p>Swarm还显示服务任务的所需状态和当前状态，以便查看任务是否根据服务定义运行。</p><p>在运行任务的节点上运行<code>docker ps</code>以查看有关任务容器的详细信息。</p><blockquote><p>如果helloworld运行在管理器节点以外的节点上，则必须将ssh连接到该节点。</p></blockquote><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">worker2</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">$ docker ps</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">CONTAINER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               COMMAND</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              PORTS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               NAMES</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">e609dde94e47</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        alpine:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">       &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       Up</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="动态扩缩容器" tabindex="-1"><a class="header-anchor" href="#动态扩缩容器"><span><strong>动态扩缩容器</strong></span></a></h4><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --replicas</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>创建三个helloworld副本，随机部署到集群里面的服务器中，不管访问哪个节点都能访问到。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --replicas</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>将集群中的helloworld副本降到1个。服务可以有多个副本动态扩缩容实现高可用！</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scale</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> scale</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">2</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>scale命令与update --replicas效果相同</p><p>运行<code>docker service ps &lt;SERVICE-ID&gt;</code>查看更新的任务列表：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworldNAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                    IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      DESIRED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  CURRENT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATEhelloworld.1.8p1vev3fq5zm0mi8g0as41w35</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minuteshelloworld.2.c7a7tcdq5s0uk3qr88mf8xco6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 24</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secondshelloworld.3.6crl09vdcalvtfehfh69ogfb1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 24</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secondshelloworld.4.auky6trawmdlcne8ad8phb0f1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  manager1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 24</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secondshelloworld.5.ba19kca06l18zujfwxyc5lkyn</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  alpine</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 24</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>swarm创建了4个新任务，以扩展到总共5个运行Alpine Linux的实例。任务分布在群的三个节点之间。一个在manager1上运行。</p><p>运行<code>docker ps</code>以查看在连接的节点上运行的容器。以下示例显示在manager1上运行的任务：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">CONTAINER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               COMMAND</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              PORTS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               NAMES</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">528d68040f95</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        alpine:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">       &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   About</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minute</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Up</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> About</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minute</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                       helloworld.4.auky6trawmdlcne8ad8phb0f1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="移除服务" tabindex="-1"><a class="header-anchor" href="#移除服务"><span><strong>移除服务</strong></span></a></h4><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rm</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>运行<code>docker service inspect&lt;service-ID&gt;</code>验证swarm manager是否删除了服务。CLI返回一条消息，指出找不到服务：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[]</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Error:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> no</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> such</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> helloworld</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>即使服务不再存在，任务容器也需要几秒钟的时间来清理。可以在节点上使用docker ps来验证任务何时被删除。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    CONTAINER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               COMMAND</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              PORTS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               NAMES</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    db1651f50347</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        alpine:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">       &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        44</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      Up</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 46</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           helloworld.5.9lkmos2beppihw95vdwxy1j3w</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    43bf6e532a92</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        alpine:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">       &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        44</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      Up</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 46</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           helloworld.3.a71i8rp6fua79ad43ycocl4t2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    5a0fb65d8fa7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        alpine:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">       &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        44</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      Up</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 45</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           helloworld.2.2jpgensh7d935qdc857pxulfr</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    afb0ba67076f</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        alpine:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">       &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        44</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      Up</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 46</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           helloworld.4.1c47o7tluz7drve4vkm2m5olx</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">    688172d3bfaa</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        alpine:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">       &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ping docker.com</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        45</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      Up</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> About</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minute</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                       helloworld.1.74nbhb3fhud8jfrhigd7s29we</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   CONTAINER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               COMMAND</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             STATUS</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="服务应用滚动更新" tabindex="-1"><a class="header-anchor" href="#服务应用滚动更新"><span><strong>服务应用滚动更新</strong></span></a></h4><p>部署一个基于redis3.0.6容器标记的服务。然后使用滚动更新将服务升级为使用redis3.0.7容器映像。</p><p><strong>将Redis标签部署到swarm，并以10秒的更新延迟配置swarm。下面的示例显示了一个旧的Redis标记：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --replicas</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --update-delay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10s</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  redis:3.0.6</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">0u6a4s31ybk7yw2wyvtikmu50</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在服务部署时配置滚动更新策略。</p><p><code>--update delay</code>标志配置服务任务或任务集更新之间的时间延迟。可以将时间<code>T</code>描述为秒数<code>Ts</code>、分钟<code>Tm</code>或小时<code>Th</code>的组合。所以10m30s表示10分30秒的延迟。</p><p>默认情况下，计划程序一次更新一个任务。可以传递<code>--update parallelism</code>标志来配置调度器同时更新的最大服务任务数。</p><p>默认情况下，当对单个任务的更新返回运行状态时，调度程序会安排另一个任务进行更新，直到所有任务都更新为止。如果在更新过程中的任何时候任务返回失败，调度程序将暂停更新。可以使用<code>docker service create</code>或<code>docker service update</code>的<code>--update failure action</code>标志来控制行为。</p><p><strong>检查redis服务：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --pretty</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             0u6a4s31ybk7yw2wyvtikmu50</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           redis</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Mode:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Replicated</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Replicas:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Placement:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Strategy:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	    Spread</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">UpdateConfig:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Parallelism:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Delay:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         10s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ContainerSpec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         redis:3.0.6</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Resources:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Endpoint</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Mode:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  vip</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>现在可以为redis更新容器镜像了。swarm manager根据UpdateConfig策略将更新应用于节点：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --image</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis:3.0.7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>默认情况下，计划程序应用滚动更新，如下所示：</p><ul><li>停止第一项任务。</li><li>已停止任务的计划更新。</li><li>启动更新任务的容器。</li><li>如果对任务的更新返回RUNNING，请等待指定的延迟时间，然后启动下一个任务。</li><li>如果在更新过程中的任何时候，任务返回失败，暂停更新。</li></ul><p><strong>运行<code>docker service inspect--pretty redis</code>以查看处于运行状态的新镜像：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --pretty</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             0u6a4s31ybk7yw2wyvtikmu50</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           redis</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Mode:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Replicated</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Replicas:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      3</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Placement:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Strategy:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">	    Spread</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">UpdateConfig:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Parallelism:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">   1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Delay:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         10s</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ContainerSpec:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Image:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         redis:3.0.7</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Resources:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Endpoint</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Mode:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  vip</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong><code>service inspect</code>的输出显示更新是否因失败而暂停：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --pretty</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             0u6a4s31ybk7yw2wyvtikmu50</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Name:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           redis</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.snip.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Update</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> status:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> State:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      paused</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Started:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">    11</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Message:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    update</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> paused</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> due</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> failure</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> or</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> early</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> termination</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> of</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> task</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 9p7ith557h8ndf0ui9s0q951b</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.snip.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>要重新启动暂停的更新，运行<code>docker service update&lt;service-ID&gt;</code>。例如：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>为了避免重复某些更新失败，也可能需要向<code>docker service update</code>传递标志来重新配置服务。</p><p><strong>运行<code>docker service ps&lt;service-ID&gt;</code>以查看滚动更新：</strong></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                   IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       DESIRED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  CURRENT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            ERROR</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.1.dos1zffgeofhagnve8w864fco</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      redis:3.0.7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 37</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> \\_</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis.1.88rdo6pa52ki8oqx6dogf04fh</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    Shutdown</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       Shutdown</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 56</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.2.9l3i4j85517skba5o7tn5m8g0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      redis:3.0.7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> About</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minute</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> \\_</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis.2.66k185wilg8ele7ntu8f6nj6i</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    Shutdown</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       Shutdown</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.3.egiuiqpzrdbxks3wxgn8qib1g</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      redis:3.0.7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 48</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> \\_</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis.3.ctzktfddb2tepkr45qcmqln04</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  mmanager1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Shutdown</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       Shutdown</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>在Swarm更新所有任务之前，可以看到一些任务正在运行redis:3.0.6 ，而其他服务正在运行redis:3.0.7，上面的输出显示了滚动更新完成后的状态。</p><h4 id="在集群上维护节点" tabindex="-1"><a class="header-anchor" href="#在集群上维护节点"><span>在集群上维护节点</span></a></h4><p>在之前的小节，所有的节点的状态都是运行着的可用状态。swarm manager 可以分配任务给任意可用的节点。</p><p>有时候，你可能需要对某台服务器进行维护，你需要配置某个节点为drain状态，即排干该节点上面的所有运行的容器。drain状态可以防止维护节点再收到 管理节点的指令。</p><p>它也意味着管理节点停止在该服务器上面运行任务，并把复制任务放到别的可用节点上面。</p><blockquote><p>重要提示：将节点设置为DRAIN不会从该节点中移除独立容器，例如使用docker run、docker compose up或docker Engine API创建的容器。节点的状态（包括DRAIN）只影响节点调度swarm服务工作负载的能力。</p></blockquote><ol><li><p>验证所有节点都处于活动可用状态。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ls</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           HOSTNAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  AVAILABILITY</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  MANAGER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATUS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1bcef6utixb0l0ca7gxuivsj0</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Active</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">38ciaotwjuritcdtn9npbnkuz</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Active</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">e216jshn25ckzbvmwlnh5jr3g</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  manager1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Active</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Leader</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>运行<code>docker service ps redis</code>查看swarm manager如何将任务分配给不同的节点：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                               IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     DESIRED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  CURRENT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.1.7q92v0nr1hcgts2amcjyqg3pq</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  manager1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 26</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.2.7h2l8h3q3wqy5f66hlv9ddmi6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 26</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.3.9bg7cezvedmkgg6c8yzvbhwsd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 26</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>运行<code>docker node update--availability drain&lt;node-ID&gt;</code>以排出已分配任务的节点：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --availability</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> drain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">worker1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>检查节点以检查其可用性：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --pretty</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker1</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">			38ciaotwjuritcdtn9npbnkuz</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Hostname:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		worker1</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Status:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> State:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">			Ready</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> Availability:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		Drain</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.snip.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>运行<code>docker service ps redis</code>查看swarm manager如何更新redis服务的任务分配：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                    IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      DESIRED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  CURRENT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           ERROR</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.1.7q92v0nr1hcgts2amcjyqg3pq</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  manager1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.2.b4hovzed7id8irg1to42egue8</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> About</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minute</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> \\_</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> redis.2.7h2l8h3q3wqy5f66hlv9ddmi6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Shutdown</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       Shutdown</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">redis.3.9bg7cezvedmkgg6c8yzvbhwsd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       redis:3.0.6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  worker2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>swarm manager通过在具有耗尽可用性的节点上结束任务并在具有活动可用性的节点上创建新任务来维持所需的状态。</p></li><li><p>运行<code>docker node update--availability active&lt;node-ID&gt;</code>以将已耗尽的节点返回到活动状态：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --availability</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> active</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker1worker1</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div></li><li><p>检查节点以查看更新的状态：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --pretty</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> worker1ID:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">			38ciaotwjuritcdtn9npbnkuzHostname:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		worker1Status:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> State:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">			Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Availability:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">		Active...snip...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>将节点设置回活动可用性时，它可以接收新任务：</p><ul><li>在服务更新期间进行扩展</li><li>在滚动更新期间</li><li>当您将另一个节点设置为耗尽可用性时</li><li>当任务在另一个活动节点上失败时</li></ul></li></ol><h4 id="使用swarm模式路由网格" tabindex="-1"><a class="header-anchor" href="#使用swarm模式路由网格"><span>使用swarm模式路由网格</span></a></h4><p>Docker Engine swarm模式使得为服务发布端口变得容易，从而使这些端口可供swarm之外的资源使用。所有节点都参与一个入口路由网。**路由网格允许群中的每个节点接受群中运行的任何服务的已发布端口上的连接，即使节点上没有运行任何任务。**路由网格将所有传入请求路由到可用节点上的已发布端口，并将其路由到活动容器。</p><p>要在swarm中使用入口网络，在启用swarm模式之前，需要在swarm节点之间打开以下端口：</p><ul><li>Port <code>7946</code> TCP/UDP 用于容器网络的端口</li><li>Port <code>4789</code> UDP 用于容器入口网络的端口</li></ul><p>除此之外，还必须打开swarm节点和任何需要访问端口的外部资源（如外部负载平衡器）之间的已发布端口。</p><p>也可以绕过给定服务的路由网格。</p><p><strong>发布服务的端口</strong></p><p>创建服务时，使用<code>--publish</code>标志发布端口。<code>target</code>用于指定容器内的端口，<code>published</code>用于指定要在路由网格上绑定的端口。如果不使用已发布的端口，则会为每个服务任务绑定一个随机的高编号端口。需要先检查任务以确定端口。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --name</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">SERVICE-NAM</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --publish</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PUBLISHED-POR</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">T</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,target=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CONTAINER-POR</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">T</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">IMAG</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><blockquote><p>注意：这种语法的旧形式是冒号分隔的字符串，其中发布的端口是第一个，目标端口是第二个，例如-p 8080:80。首选新语法，因为它更易于阅读，并且允许更大的灵活性。</p></blockquote><p><code>&lt;PUBLISHED-PORT&gt;</code>是swarm提供服务的端口。如果忽略它，则会绑定一个随机的高位端口。<code>&lt;CONTAINER-PORT&gt;</code>是容器侦听的端口。此参数是必需的。</p><p>例如，以下命令将nginx容器中的端口80发布到swarm中任何节点的端口8080：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-web</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --publish</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=8080,target=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">80</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --replicas</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  nginx</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当访问任何节点上的端口8080时，Docker会将请求路由到活动容器。在swarm节点本身上，端口8080实际上可能没有被绑定，但是路由网格知道如何路由通行并防止任何端口冲突的发生。</p><p>路由网格在发布的端口上侦听分配给节点的任何IP地址。对于外部可路由的IP地址，端口可从主机外部获得。对于所有其他IP地址，只能从主机内部访问。</p><p><img src="https://file.40017.cn/baoxian/health/health_public/images/blog/blog-8.png" alt="img"></p><p>可以使用以下命令发布现有服务的端口：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> update</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --publish-add</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PUBLISHED-POR</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">T</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">,target=</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CONTAINER-POR</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">T</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">  &lt;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">SERVIC</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">E</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>您可以使用<code>docker service inspect</code>查看服务的已发布端口。例如：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> inspect</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --format=</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">{{json .Endpoint.Spec.Ports}}</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-web</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">{</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Protocol</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">tcp</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">TargetPort</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:80,</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">PublishedPort</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:8080}</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>输出显示来自容器的<code>&lt;CONTAINER-PORT&gt;</code>（标记为TargetPort）和节点侦听服务请求的<code>&lt;PUBLISHED-PORT&gt;</code>（标记为PublishedPort）。</p><p><strong>仅为TCP或UDP发布端口</strong></p><p>默认情况下，发布端口时，它是TCP端口。可以专门发布UDP端口而不是TCP端口，也可以在TCP端口之外发布。发布TCP和UDP端口时，如果省略协议说明符，则该端口将发布为TCP端口。如果使用较长的语法（推荐），请将协议密钥设置为tcp或udp。</p><p><strong>仅为TCP</strong></p><p>长语法：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --publish</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=53,target=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">53</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  dns-cache</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>短语法：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 53:53</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  dns-cache</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>TCP和UDP</strong></p><p>长语法：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --publish</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=53,target=</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">53</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --publish</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=53,target=53,protocol=udp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  dns-cache</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>短语法：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 53:53</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 53:53/udp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  dns-cache</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>仅为UDP</strong></p><p>长语法：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  --publish</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=53,target=53,protocol=udp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  dns-cache</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>短语法：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">  -p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 53:53/udp</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  dns-cache</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>绕过路由网格</strong></p><p>可以绕过路由网格，以便在访问给定节点上的绑定端口时，始终访问该节点上运行的服务实例。这称为主机模式。有几件事要记住。</p><ul><li>如果访问的节点未运行服务任务，则服务不会侦听该端口。有可能是什么都没有在侦听，或者是一个完全不同的应用程序正在侦听。</li><li>如果希望在每个节点上运行多个服务任务（例如当有5个节点但运行10个副本时），则不能指定静态目标端口。允许Docker分配一个随机的高编号端口（不使用已发布的端口），或者通过使用全局服务而不是复制的服务，或者通过使用放置约束，确保只有一个服务实例在给定节点上运行。</li></ul><p>要绕过路由网格，必须使用长语法<code>--publish</code>服务并将<code>mode</code>设置为<code>host</code>。如果省略<code>mode</code>键值或将其设置为<code>ingress</code>，则使用路由网格。下面的命令使用主机模式创建全局服务并绕过路由网格。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">$</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\ </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --publish</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> published=53,target=53,protocol=udp,mode=host</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\ </span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> --mode</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> \\ </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dns-cache</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p><strong>配置外部负载平衡器</strong></p><p>可以为swarm服务配置外部负载均衡器，可以与路由网格结合使用，也可以完全不使用路由网格。</p><ul><li><p>使用路由网格</p><p>可以配置外部负载平衡器将请求路由到swarm服务。例如，可以配置HAProxy来平衡对发布到端口8080的nginx服务的请求。</p><p><img src="https://file.40017.cn/baoxian/health/health_public/images/blog/blog-9.png" alt="img"></p></li></ul><p>在这种情况下，端口8080必须在负载平衡器和群中的节点之间打开。swarm节点可以驻留在代理服务器可访问但不可公开访问的专用网络上。</p><p>您可以将负载均衡器配置为在集群中的每个节点之间平衡请求，即使节点上没有计划任务。例如，您可以在<code>/etc/HAProxy/HAProxy.cfg</code>中具有以下HAProxy配置：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">global</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /dev/log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    local0</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">        log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /dev/log</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    local1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> notice</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">.snip.</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">..</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Configure HAProxy to listen on port 80</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">frontend</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http_front</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   bind</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">:80</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   stats</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> uri</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /haproxy?stats</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   default_backend</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http_back</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"># Configure HAProxy to route requests to swarm nodes on port 8080</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">backend</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> http_back</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   balance</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> roundrobin</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.99.100:8080</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> check</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.99.101:8080</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> check</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">   server</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 192.168.99.102:8080</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> check</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>当访问端口80上的HAProxy负载平衡器时，它会将请求转发给swarm中的节点。swarm路由网格将请求路由到活动任务。如果swarm调度器出于任何原因将任务分派到不同的节点，则不需要重新配置负载平衡器。</p><p>您可以配置任何类型的负载平衡器将请求路由到swarm节点。要了解有关HAProxy的更多信息，请参阅 <a href="https://cbonte.github.io/haproxy-dconv/" target="_blank" rel="noopener noreferrer">HAProxy documentation</a>。</p><p><strong>没有路由网格</strong></p><p>要使用没有路由网格的外部负载平衡器，将<code>--endpoint mode</code>设置为<code>dnsrr</code>，而不是<code>vip</code>的默认值。在这种情况下，没有单个虚拟IP。相反，Docker为服务设置DNS条目，以便对服务名称的DNS查询返回IP地址列表，并且客户端直接连接到其中一个。您负责向负载平衡器提供IP地址和端口的列表。请参阅<a href="https://docs.docker.com/engine/swarm/networking/#configure-service-discovery" target="_blank" rel="noopener noreferrer">Configure service discovery</a>。</p><h3 id="概念总结" tabindex="-1"><a class="header-anchor" href="#概念总结"><span>概念总结</span></a></h3><ul><li><p><strong>swarm</strong></p><p>集群的管理和编号。docker可以初始化一个swarm集群，其他节点可以加入。（管理者、工作者）</p></li><li><p><strong>Node</strong></p><p>就是一个docker节点。多个节点就组成了一个网络集群。（管理者、工作者）</p></li><li><p><strong>Service</strong></p><p>任务，可以在管理节点或者工作节点来运行。核心，用户访问的服务。</p></li><li><p><strong>Task</strong></p><p>容器内的命令，细节任务。</p></li></ul><p><img src="https://file.40017.cn/baoxian/health/health_public/images/blog/blog-10.png" alt="image-20210520230135055.png"></p><h2 id="docker-stack" tabindex="-1"><a class="header-anchor" href="#docker-stack"><span>Docker Stack</span></a></h2><p>Docker Stack学习笔记引用地址：https://www.cnblogs.com/hhhhuanzi/p/12273249.html</p><h3 id="简介-1" tabindex="-1"><a class="header-anchor" href="#简介-1"><span>简介</span></a></h3><p>Docker Stack 是为了解决大规模场景下的多服务部署和管理，提供了<code>期望状态</code>，<code>滚动升级</code>，<code>简单易用</code>，<code>扩缩容</code>，<code>健康检查</code>等特性，并且都封装在一个声明式模型当中。</p><ul><li>Docker Stack 部署应用的生命周期：<code>初始化部署 &gt; 健康检查 &gt; 扩容 &gt; 更新 &gt; 回滚</code>。</li><li>使用单一声明式文件即可完成部署，即只需要<code>docker-stack.yml</code>文件，使用<code>docker stack deploy</code>命令即可完成部署。</li><li>stack 文件其实就是 Docker compose 文件，唯一的要求就是 version 需要为 3.0 或者更高的值。</li><li>Stack 完全集成到了 Docker 中，不像 compose 还需要单独安装。</li></ul><p><strong>Docker 适用于开发和测试，而 Docker Stack 则适用于大规模场景和生产环境</strong></p><h3 id="docker-stack-yml文件详解" tabindex="-1"><a class="header-anchor" href="#docker-stack-yml文件详解"><span>Docker-stack.yml文件详解</span></a></h3><p>从 GitHub 中拉取示例代码，分析其中的 <code>docker-stack.yml</code> 文件</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">git</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> clone</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> https://github.com/dockersamples/atsea-sample-shop-app.git</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>可以看到有 5 个服务，3 个网络，4 个秘钥，3 组端口映射；</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  reverse_proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  database</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  appserver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  visualizer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  payment_gateway</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  front-tier</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  back-tier</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  payment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  postgres_password</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  staging_token</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  revprox_key</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  revprox_cert</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="网络" tabindex="-1"><a class="header-anchor" href="#网络"><span>网络</span></a></h4><p>Docker 根据 stack 文件部署的时候，第一步会检查并创建 <code>networks：关键字</code>对应的网络。默认会创建覆盖网络（overlay），并且控制层会加密，如果需要对数据层加密，可以在 stack 文件的 driver_opts 之下指定 encrypted:&#39;yes&#39;，数据层加密会导致额外开销，但是一般不会超过10%。</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  front-tier</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  back-tier</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  payment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    driver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> overlay</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    driver_opts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      encrypted</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">yes</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><strong>3 个网络都会先于秘钥和服务被创建</strong></p><h4 id="密钥" tabindex="-1"><a class="header-anchor" href="#密钥"><span>密钥</span></a></h4><p>当前 Stack 文件中定义了 4 个秘钥，并且都是<code>external</code>，这表示在 Stack 部署前，这些秘钥必须已存在</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  postgres_password</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    external</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  staging_token</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    external</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  revprox_key</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    external</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  revprox_cert</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    external</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#1E754F;--shiki-dark:#4D9375;"> true</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><h4 id="服务" tabindex="-1"><a class="header-anchor" href="#服务"><span>服务</span></a></h4><p>总共有 5 个服务，我们依次进行分析</p><ol><li><p><code>reverse_proxy</code> 服务</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">reverse_proxy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dockersamples/atseasampleshopapp_reverse_proxy</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">80:80</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">443:443</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> source</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> revprox_cert</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> revprox_cert</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> source</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> revprox_key</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> revprox_key</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> front-tier</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>image</code>：必填项，指定了用于构建服务副本的 Docker 镜像</li><li><code>ports</code>：Swarm 节点的 80 端口映射到副本的 80 端口，443 端口映射到副本的 443 端口</li><li><code>secrets</code>：2 个秘钥以普通文件形式挂载至服务副本中，文件名称就是 target 属性的值，路径为<code>/run/secrets</code></li><li><code>networks</code>：所有副本都会连接到 front-tier 网络，如果定义的网络不存在，Docker 会以 Overlay 的网络方式新建一个</li></ul></li><li><p><code>database</code> 服务</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">database</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> dockersamples/atsea_db    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      POSTGRES_USER</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> gordonuser      POSTGRES_DB_PASSWORD_FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> /run/secrets/postgres_password      POSTGRES_DB</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> atsea    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> back-tier    secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> postgres_password    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      placement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        constraints</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node.role == worker</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>多了以下几项：</p><ul><li><code>environment</code>：环境变量，定义了数据库用户，密码位置，数据库名称</li><li><code>deploy</code>：部署约束，服务只运行在 Swarm 集群的 Worker 节点上</li></ul><p>Swarm 目前允许以下几种部署约束方式：</p><ul><li>节点 ID ：<code>node.id == 85v90bioyy4s2fst4fa5vrlvf</code></li><li>节点名称：<code>node.hostname == huanzi-002</code></li><li>节点角色：<code>node.role != manager</code></li><li>节点引擎标签：<code>engine.labels.operatingsystem == Centos 7.5</code></li><li>节点自定义标签：<code>node.labels.zone == test01</code></li></ul><p>支持<code>==</code>和<code>!=</code>操作。</p></li><li><p><code>appserver</code> 服务</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">appserver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dockersamples/atsea_app</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> front-tier</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> back-tier</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> payment</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      replicas</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      update_config</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        parallelism</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        failure_action</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rollback</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      placement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        constraints</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node.role == worker</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      restart_policy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        condition</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> on-failure</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        delay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5s</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        max_attempts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        window</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 120s</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> postgres_password</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>deploy-replicas</code>：部署的服务副本数量</li><li><code>deploy-update_config</code>：滚动升级时的操作，每次更新 2 个副本（parallelism：2），升级失败以后回滚（failure_action: rollback）</li><li><code>failure_action</code>默认为 pause ，即服务升级失败后阻止其它副本的升级，还支持 continue</li><li><code>restart_policy</code>：容器异常退出的重启策略，当前策略为：如果某个副本以非 0 返回值退出（condition: on-failure），会立即重启当前副本，重启最多重试 3 次，每次最多等待 120s，每次重启间隔是 5s。</li></ul></li><li><p><code>visualizer</code> 服务</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">visualizer</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dockersamples/visualizer:stable</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">8001:8080</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    stop_grace_period</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 1m30s</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">/var/run/docker.sock:/var/run/docker.sock</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      update_config</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        failure_action</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rollback</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      placement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        constraints</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node.role == manager</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><ul><li><code>stop_grace_period</code>：设置容器优雅停止时长（Docker 停止某个容器时，会给容器内 PID 为 1 的进程发送一个 SIGTERM 信号，容器内 PID 为 1 的进程有 10s 的优雅停止时长来执行清理操作）</li><li><code>volumes</code>：挂载提前创建的卷或者主机目录至某个服务副本中，本例中<code>/var/run/docker.sock</code>为Docker 的 IPC 套接字，Docker daemon 通过该套接字对其它进程暴露 API 终端，如果某个容器有该文件的访问权限，即允许该容器访问所有的 API 终端，并且可以查询及管理 Docker daemon。<strong>生产环境严禁使用该操作</strong></li></ul></li><li><p><code>payment_gateway</code> 服务</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">payment_gateway</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dockersamples/atseasampleshopapp_payment_gateway</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#998418;--shiki-dark:#B8A965;"> source</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> staging_token</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        target</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> payment_token</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> payment</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      update_config</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        failure_action</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> rollback</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      placement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        constraints</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node.role == worker</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">node.labels.pcidss == yes</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p><code>node.labels</code>：自定义节点标签，可以通过<code>docker node update</code>自定义，并添加至 Swarm 集群的指定节点。这说明，node.labels 配置只适用于 Swarm 集群中指定的节点。</p></li></ol><h3 id="部署docker-stack" tabindex="-1"><a class="header-anchor" href="#部署docker-stack"><span>部署docker stack</span></a></h3><h4 id="准备工作" tabindex="-1"><a class="header-anchor" href="#准备工作"><span>准备工作</span></a></h4><ul><li>自定义标签（payment_gateway 服务需要用到）</li><li>密钥（提前创建 4 个）</li></ul><p>给工作节点 huanzi-002 新建一个自定义标签，在管理节点上操作</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker node ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                            HOSTNAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              AVAILABILITY</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        MANAGER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      ENGINE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> VERSION</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">8bet9fg0tnoqlfp0ebrrqdapn</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> *</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   huanzi-001</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               Active</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              Leader</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">              19.03.5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">85v90bioyy4s2fst4fa5vrlvf</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     huanzi-002</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               Active</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                                  19.03.5</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">8hxs2p5iblj19xg9uqpu8ar8g</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     huanzi-003</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Ready</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               Active</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                                  19.03.5</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker node update --label-add </span><span style="--shiki-light:#B07D48;--shiki-dark:#BD976A;">pcidss</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">=</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">yes</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> huanzi-002</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">huanzi-002</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker node inspect huanzi-002</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ID</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">85v90bioyy4s2fst4fa5vrlvf</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Index</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">726</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CreatedAt</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2020-02-02T08:11:34.982719258Z</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">UpdatedAt</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2020-02-06T10:22:25.44331302Z</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Spec</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Labels</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">                &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">pcidss</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">yes</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">        &lt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">...</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到自定义标签已经成功创建。</p><p>接下来创建密钥，先创建加密 key</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 daemon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># openssl req -newkey rsa:4096 -nodes -sha256 -keyout damain.key -x509 -days 365 -out domain.crt</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Generating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 4096</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> bit</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> RSA</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> private</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> key</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">....................................</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">++</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...........................................</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">++</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">writing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> new</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> private</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> key</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">damain.key</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">-----</span></span>
<span class="line"><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&lt;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">...</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">&gt;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Country</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (2 </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">letter</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> code</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">XX</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">State</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> or</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Province</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (full </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Locality</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (eg, </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">city</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Default City</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Organization</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (eg, </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">company</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">Default Company Ltd</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Organizational</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Unit</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (eg, </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">section</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">) </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Common</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Name</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (eg, </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">your</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> name</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> or</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> your</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> server</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">s hostname) []:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Email Address []:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">[root@huanzi-001 daemon]# ls</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">atsea-sample-shop-app  damain.key  domain.crt</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建需要加密 key 的<code>revprox_cert</code>，<code>revprox_key</code>，<code>postgres_password</code>这 3 个密钥</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 daemon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret create revprox_cert domain.crt </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lue5qk6ophxrr6aspyhnkhvsv</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 daemon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret create revprox_key damain.key </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">glvfk78kn6665lmkci7tslrw6</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 daemon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret create postgres_password damain.key </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pxdfs28hb2897xuu7f3bub7ex</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>创建不需要加密 key 的<code>staging_token</code>密钥</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 daemon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># echo staging </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">|</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secret</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> staging_token</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> -</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cyqfn9jocvnxd2vr57gn5pioj</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 daemon</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                DRIVER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              UPDATED</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">pxdfs28hb2897xuu7f3bub7ex</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   postgres_password</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                       15</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       15</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">lue5qk6ophxrr6aspyhnkhvsv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   revprox_cert</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                            16</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       16</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">glvfk78kn6665lmkci7tslrw6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   revprox_key</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                             16</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       16</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">cyqfn9jocvnxd2vr57gn5pioj</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   staging_token</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           About</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minute</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   About</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minute</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>现在自定义标签，及密钥全部创建完毕。</p><h4 id="开始部署" tabindex="-1"><a class="header-anchor" href="#开始部署"><span>开始部署</span></a></h4><p>命令：<code>docker stack deploy -c &lt;docker-stack.yml&gt; &lt;stack name&gt;</code></p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker stack deploy -c docker-stack.yml huanzi-stack</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_front-tier</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_back-tier</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_default</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_payment</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_payment_gateway</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_reverse_proxy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_database</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_appserver</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Creating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_visualizer</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看出，先创建了 4 个网络，再创建的服务，我们验证一下网络是否创建了</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker network ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NETWORK</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                      DRIVER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              SCOPE</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">34306420befb</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        bridge</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                    bridge</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              local</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ac57c15024c7</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        docker_gwbridge</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           bridge</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              local</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">e863472805b3</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        host</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                      host</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                local</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ojt9cxg2qsxe</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-net</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                overlay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             swarm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">o74roe621idx</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_back-tier</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    overlay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             swarm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">k55m237m11ct</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_default</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      overlay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             swarm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">idpvc5xg2g2t</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_front-tier</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   overlay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             swarm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">uvphcut0a825</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_payment</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      overlay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             swarm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">7d6iv5ilwbcn</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        ingress</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                   overlay</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             swarm</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">d302c895b455</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        lovehuanzi</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                bridge</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              local</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">eefd134326c4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        none</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                      null</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                local</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>看到了 4 个 <code>huanzi-stack</code> 前缀的网络。为什么多了一个<code>huanzi-stack-default</code>,因为<code>visualizer</code> 服务没有指定网络，因此 Docker 创建了一个 defalut 的网络给它用。</p><p>再验证下服务</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">root@huanzi-001</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> atsea-sample-shop-app]#</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stack</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                SERVICES</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            ORCHESTRATOR</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">huanzi-stack</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">        5</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                   Swarm</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker stack ps huanzi-stack </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                             IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                                                     NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                DESIRED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       CURRENT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             ERROR</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               PORTS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ex55yaz21mra</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_appserver.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         dockersamples/atsea_app:latest</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                            huanzi-003</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             Preparing</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                       </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">jshmzquzxi8p</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_database.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          dockersamples/atsea_db:latest</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                             huanzi-002</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             Preparing</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                       </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">k7mi1419ahwd</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_reverse_proxy.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     dockersamples/atseasampleshopapp_reverse_proxy:latest</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     huanzi-003</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             Preparing</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                       </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">09ocoutjfc70</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_payment_gateway.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   dockersamples/atseasampleshopapp_payment_gateway:latest</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   huanzi-002</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             Preparing</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                       </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">y6lftn8g95b8</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_visualizer.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        dockersamples/visualizer:stable</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                           huanzi-001</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             Preparing</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">                       </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">5twm1k4uj5ps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        huanzi-stack_appserver.2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         dockersamples/atsea_app:latest</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                            huanzi-002</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             Preparing</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 2</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到满足 stack 文件的要求：</p><ul><li><code>reverse_proxy</code>：副本数量 <code>1</code></li><li><code>database</code>：副本数量 <code>1</code>，位于<code>worker</code></li><li><code>appserver</code>：副本数量 <code>2</code>，位于<code>worker</code></li><li><code>visualizer</code>：副本数量 <code>1</code>，位于<code>manager</code></li><li><code>payment_gateway</code>：副本数量 <code>1</code>，位于<code>worker</code>，自定义标签<code>pcidss == yes</code>（即 huanzi-002 ）</li></ul><h4 id="管理stack" tabindex="-1"><a class="header-anchor" href="#管理stack"><span>管理Stack</span></a></h4><ol><li><p>扩容</p><p>将<code>appserver</code>的副本数从 2 扩至 10，有 2 种方式：</p><ul><li>通过<code>docker service scale appserver=10</code></li><li>直接修改<code>docker-stack.yml</code>文件，再通过<code>docker stack deploy</code>重新部署</li></ul><p><strong>所有的变更都应该通过 Stack 文件进行声明，然后通过 docker stack deploy 进行部署</strong></p><p>修改<code>docker-stack.yml</code>文件</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">appserver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> dockersamples/atsea_app</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> front-tier</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> back-tier</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> payment</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      replicas</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 10</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>重新部署</p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker stack deploy -c docker-stack.yml huanzi-stack </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Updating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_reverse_proxy</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (id: </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">i2yn8l50ofnmbx0a55mum1dw0</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Updating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_database</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (id: </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ubrtixblmj685pnc97wql42cm</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Updating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_appserver</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (id: </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">yy447jdp1eiwb03ljdsqtyg1g</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Updating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_visualizer</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (id: </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">rhzzxov0jh1y38rxcj6bwe89y</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Updating</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_payment_gateway</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> (id: </span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">niobpxv5vr1njoo37vnje8zic</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">)</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看重新部署的stack</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> stack</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ps</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>扩容完成。</p></li><li><p>删除</p><p>命令：<code>docker stack rm &lt;stack name&gt;</code></p><div class="language-bash line-numbers-mode" data-ext="bash" data-title="bash"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@huanzi-001 atsea-sample-shop-app</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker stack rm huanzi-stack </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_appserver</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_database</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_payment_gateway</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_reverse_proxy</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_visualizer</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_front-tier</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_default</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_back-tier</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Removing</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> network</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> huanzi-stack_payment</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看出，<code>rm</code>会删除服务及网络，但是密钥和卷不会删除</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">root@huanzi-001</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> atsea-sample-shop-app]#</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secret</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> lsID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                DRIVER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             UPDATEDpxdfs28hb2897xuu7f3bub7ex</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   postgres_password</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                       53</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      53</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> agolue5qk6ophxrr6aspyhnkhvsv</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   revprox_cert</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                            55</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      55</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> agoglvfk78kn6665lmkci7tslrw6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   revprox_key</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                             54</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      54</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> agocyqfn9jocvnxd2vr57gn5pioj</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   staging_token</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                           40</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      40</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>一般一个环境需要一个stack文件。比如dev，test，prod。</p></li></ol><h2 id="docker-secret" tabindex="-1"><a class="header-anchor" href="#docker-secret"><span>Docker Secret</span></a></h2><p>文章引用：https://www.cnblogs.com/shenjianping/p/12272847.html</p><h3 id="什么是docker-secret" tabindex="-1"><a class="header-anchor" href="#什么是docker-secret"><span>什么是Docker Secret</span></a></h3><ol><li><p>情景展现</p><p>我们知道有的service是需要设置密码的，比如mysql服务是需要设置密码的：</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  web</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 8080:80</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ./www:/var/www/html</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      WORDPRESS_DB_NAME=wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_HOST</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_PASSWORD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-network</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    depends_on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      mode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> replicated</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      replicas</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      restart_policy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        condition</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> on-failure</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        delay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5s</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        max_attempts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      update_config</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        parallelism</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        delay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10s</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  mysql</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_ROOT_PASSWORD</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> root</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_DATABASE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql-data:/var/lib/mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-network</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      mode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      placement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        constraints</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node.role == manager</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  mysql-data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  my-network</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    driver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> overlay</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到在这个docker-compose.yml中的两个service密码都是明文，这样就导致了不是很安全，那么究竟什么是Docker secret以及能否解决上面的问题呢？</p></li><li><p>Docker Secret</p><p><img src="https://file.40017.cn/baoxian/health/health_public/images/blog/blog-10.png" alt="image"></p><p>​ 我们知道manager节点保持状态的一致是通过Raft Database这个分布式存储的数据库，它本身就是将信息进行了secret，所以可以利用这个数据库将一些敏感信息，例如账号、密码等信息保存在这里，然后通过给service授权的方式允许它进行访问，这样达到避免密码明文显示的效果。</p><p>​ 总之，secret的Swarm中secret的管理通过以下步骤完成：</p><ul><li>secret存在于Swarm Manager节点的的Raft Database里</li><li>secret可以assign给一个service，然后这个service就可以看到这个secret</li><li>在container内部secret看起来像文件，实际上就是内存</li></ul></li></ol><h3 id="docker-secret的创建与使用" tabindex="-1"><a class="header-anchor" href="#docker-secret的创建与使用"><span>Docker Secret的创建与使用</span></a></h3><h4 id="创建" tabindex="-1"><a class="header-anchor" href="#创建"><span>创建</span></a></h4><p>Secret的创建有两种方式，分别是：</p><ul><li>基于文件的创建</li><li>基于命令行创建</li></ul><ol><li><p>基于文件创建</p><p>首先先创建一个文件用于存放密码</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># vim mysql-password</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">root</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>然后再进行创建secret</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret create mysql-pass mysql-password </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">texcct9ojqcz6n40woe97dd7k</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div></div></div><p>其中，mysql-pass是secret的名称，mysql-password是我们建立存储密码的文件，这样执行后就相当于将文件中的密码存储在Swarm中manager节点的Raft Database中了。为了安全起见，现在可以直接将这个文件删掉，因为Swarm中已经有这个密码了。</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># rm -f mysql-password</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>现在可以查看一下secret列表：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                DRIVER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             UPDATED</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">texcct9ojqcz6n40woe97dd7k</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   mysql-pass</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                              4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">       4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>已经存在了。</p></li><li><p>基于命令行创建</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># echo </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">root</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;"> |</span><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secret</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql-pass2</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;"> -hrtmn5yr3r3k66o39ba91r2e4</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#A65E2B;--shiki-dark:#C99076;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret lsID                          NAME                DRIVER              CREATED             UPDATEDtexcct9ojqcz6n40woe97dd7k   mysql-pass                              6 minutes ago       6 minutes agohrtmn5yr3r3k66o39ba91r2e4   mysql-pass2                             5 seconds ago       5 seconds ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div></div></div><p>这种方式还是很简单的就创建成功了</p></li></ol><h4 id="其他操作" tabindex="-1"><a class="header-anchor" href="#其他操作"><span>其他操作</span></a></h4><ol><li><p>inspect</p><p>展示secret的一些详情信息</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret inspect mysql-pass2</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">ID</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">hrtmn5yr3r3k66o39ba91r2e4</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Version</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Index</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">4061</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        },</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">CreatedAt</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2020-02-07T08:39:25.630341396Z</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">UpdatedAt</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">2020-02-07T08:39:25.630341396Z</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">        &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Spec</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Name</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">mysql-pass2</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">,</span></span>
<span class="line"><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">            &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">Labels</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">: {}</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">        }</span></span>
<span class="line"><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">    }</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li><li><p>rm</p><p>删除一个secret</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret rm  mysql-pass2</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql-pass2</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker secret ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                          NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                DRIVER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">              CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             UPDATED</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">texcct9ojqcz6n40woe97dd7k</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   mysql-pass</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">                              12</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;">      12</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div></li></ol><h4 id="secret在单容器中的使用" tabindex="-1"><a class="header-anchor" href="#secret在单容器中的使用"><span>Secret在单容器中的使用</span></a></h4><ol><li><p>容器中查看secret</p><p>我们创建了一个secret，如何在启动一个服务后，将其授权给特定的服务然后它才可以看到呢？先看看创建服务的命令中是否有类似的命令或者参数：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker service create --help</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Usage:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    docker</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> create</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> [OPTIONS] IMAGE </span><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">COMMAND</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#999999;--shiki-dark:#666666;"> [</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">ARG...</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Create</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> a</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> new</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">Options:</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">      --config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> config</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                      Specify</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> configurations</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> expose</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> the</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;"> --secret</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secret</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                      Specify</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> secrets</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> expose</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> to</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> the</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> service</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">...</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>确实是有这样的命令，在创建服务时可以给服务暴露出secret。</p></li><li><p>创建服务</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker service create --name demo --secret mysql-pass busybox sh -c </span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">while true; do sleep 3600; done</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">zwgk5w0rpf17hn77axz6cn8di</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">overall</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> progress:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> out</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> of</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> tasks</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"> </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">1/1:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> running</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">   </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">verify:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> Service</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> converged</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>查看这个服务运行在那个节点上：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker service ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           MODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                REPLICAS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">            IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               PORTS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">zwgk5w0rpf17</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        demo</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           replicated</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">          1/1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                 busybox:latest</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">      </span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@centos-7 </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker service ps demo</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">                  NAME</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    NODE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">         DESIRED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">       CURRENT</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> STATE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">     ERROR</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  PORTS</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">yvr9lwvg8oca</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        demo.1</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">        busybox:latest</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">      localhost.localdomain</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Running</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 51</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> seconds</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到这个服务运行在localhost.localdomain主机的节点上，我们去这个节点上进入到容器内部，看是否能查看secret：</p><div class="language-shell line-numbers-mode" data-ext="shell" data-title="shell"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@localhost </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker ps</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">CONTAINER</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ID</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    IMAGE</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               COMMAND</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">           CREATED</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">             STATUS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">    PORTS</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">               NAMES</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">36573adf21f6</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  busybox:latest</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">   &quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">sh -c &#39;while true; …</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&quot;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> ago</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   Up</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 4</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> minutes</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  demo.1.yvr9lwvg8ocatym20hdfublhd</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">[</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;">root@localhost </span><span style="--shiki-light:#AB5959;--shiki-dark:#CB7676;">~</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">]</span><span style="--shiki-light:#393A34;--shiki-dark:#DBD7CAEE;"># docker exec -it 36573adf21f6 /bin/sh</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">bin</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   dev</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   etc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   home</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  proc</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  root</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">  run</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   sys</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   tmp</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   usr</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">   var</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # cd /run/secrets</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/run/secrets</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # ls</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">mysql-pass</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/run/secrets</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> # cat mysql-pass </span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">root</span></span>
<span class="line"><span style="--shiki-light:#59873A;--shiki-dark:#80A665;">/run/secrets</span><span style="--shiki-light:#A0ADA0;--shiki-dark:#758575DD;"> #</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>可以看到确实是可行的。</p></li></ol><h4 id="secret在stack中的使用" tabindex="-1"><a class="header-anchor" href="#secret在stack中的使用"><span>Secret在Stack中的使用</span></a></h4><p>Stack利用的就是docker-compose.yml文件来部署stack，那么如何在docker-compose.yml中来定义secret呢？</p><div class="language-yaml line-numbers-mode" data-ext="yaml" data-title="yaml"><button class="copy" title="复制代码" data-copied="已复制"></button><pre class="shiki shiki-themes vitesse-light vitesse-dark vp-code"><code><span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">version</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;"> &#39;</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;">3</span><span style="--shiki-light:#B5695977;--shiki-dark:#C98A7D77;">&#39;</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">services</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  web</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    ports</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 8080:80</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-pw</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_HOST</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      WORDPRESS_DB_PASSWORD_FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /run/secrets/wordpress-pass</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-network</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    depends_on</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      mode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> replicated</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      replicas</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      restart_policy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        condition</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> on-failure</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        delay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 5s</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        max_attempts</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 3</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      update_config</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        parallelism</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#2F798A;--shiki-dark:#4C9A91;"> 1</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        delay</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> 10s</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  mysql</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    image</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    secrets</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-pw</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    environment</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_ROOT_PASSWORD_FILE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> /run/secrets/mysql-pass</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      MYSQL_DATABASE</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> wordpress</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> mysql-data:/var/lib/mysql</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">      -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> my-network</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    deploy</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      mode</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> global</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">      placement</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">        constraints</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#999999;--shiki-dark:#666666;">          -</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> node.role == manager</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">volumes</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  mysql-data</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">networks</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">  my-network</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span></span>
<span class="line"><span style="--shiki-light:#998418;--shiki-dark:#B8A965;">    driver</span><span style="--shiki-light:#999999;--shiki-dark:#666666;">:</span><span style="--shiki-light:#B56959;--shiki-dark:#C98A7D;"> overlay</span></span></code></pre><div class="line-numbers" aria-hidden="true" style="counter-reset:line-number 0;"><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div><div class="line-number"></div></div></div><p>上面通过在environment中定义WORDPRESS_DB_PASSWORD_FILE以及MYSQL_ROOT_PASSWORD_FILE来制定secret，显然我们在运行这个docker-compose.yml文件之前必须先要进行对应的secret文件的创建。然后就可以通过docker stack deploy命令来部署这个stack了。</p><h2 id="docker-config" tabindex="-1"><a class="header-anchor" href="#docker-config"><span>Docker Config</span></a></h2><p>官方文档：https://docs.docker.com/engine/reference/commandline/config/</p>`,246)]))}const p=i(e,[["render",h],["__file","index.html.vue"]]),d=JSON.parse('{"path":"/article/280rm7bg/","title":"Docker进阶","lang":"zh-CN","frontmatter":{"title":"Docker进阶","tags":["笔记","学习","docker"],"createTime":"2021/10/11","permalink":"/article/280rm7bg/","description":"Docker Compose 简介 Docker Compose 是 Docker 官方编排(Orchestration)项目之一，负责快速在集群中部署分布式应用。该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。 Dockerfile 可以让用户管理一个单独的应用容器;而 Compose 则允许用户在一个模板(YAML...","head":[["meta",{"property":"og:url","content":"https://jyqwq.github.io/rainbow/article/280rm7bg/"}],["meta",{"property":"og:site_name","content":"纸上的彩虹"}],["meta",{"property":"og:title","content":"Docker进阶"}],["meta",{"property":"og:description","content":"Docker Compose 简介 Docker Compose 是 Docker 官方编排(Orchestration)项目之一，负责快速在集群中部署分布式应用。该项目由 Python 编写，实际上调用了 Docker 提供的 API 来实现。 Dockerfile 可以让用户管理一个单独的应用容器;而 Compose 则允许用户在一个模板(YAML..."}],["meta",{"property":"og:type","content":"article"}],["meta",{"property":"og:image","content":"https://file.40017.cn/baoxian/health/health_public/images/blog/blog-6.png"}],["meta",{"property":"og:locale","content":"zh-CN"}],["meta",{"property":"og:updated_time","content":"2024-12-02T08:08:41.000Z"}],["meta",{"property":"article:tag","content":"笔记"}],["meta",{"property":"article:tag","content":"学习"}],["meta",{"property":"article:tag","content":"docker"}],["meta",{"property":"article:modified_time","content":"2024-12-02T08:08:41.000Z"}],["script",{"type":"application/ld+json"},"{\\"@context\\":\\"https://schema.org\\",\\"@type\\":\\"Article\\",\\"headline\\":\\"Docker进阶\\",\\"image\\":[\\"https://file.40017.cn/baoxian/health/health_public/images/blog/blog-6.png\\",\\"https://file.40017.cn/baoxian/health/health_public/images/blog/blog-7.png\\",\\"https://file.40017.cn/baoxian/health/health_public/images/blog/blog-8.png\\",\\"https://file.40017.cn/baoxian/health/health_public/images/blog/blog-9.png\\",\\"https://file.40017.cn/baoxian/health/health_public/images/blog/blog-10.png\\",\\"https://file.40017.cn/baoxian/health/health_public/images/blog/blog-10.png\\"],\\"dateModified\\":\\"2024-12-02T08:08:41.000Z\\",\\"author\\":[]}"]]},"headers":[],"readingTime":{"minutes":32.15,"words":9646},"git":{"updatedTime":1733126921000,"contributors":[{"name":"yuan.ji","email":"yuan.ji@ly.com","commits":1,"avatar":"https://avatars.githubusercontent.com/yuan.ji?v=4","url":"https://github.com/yuan.ji"}]},"autoDesc":true,"filePathRelative":"日常学习/Docker进阶.md","categoryList":[{"id":"9a91b4","sort":10003,"name":"日常学习"}],"bulletin":false}');export{p as comp,d as data};
